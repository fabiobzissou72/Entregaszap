<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Webhook - Entregas ZAP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Webhook - Entregas ZAP</h1>

        <!-- Teste 1: Webhook B√°sico -->
        <div class="test-section">
            <h2>1. Teste B√°sico do Webhook</h2>
            <p>Envia uma requisi√ß√£o simples para testar se o webhook est√° respondendo.</p>

            <label>URL do Webhook:</label>
            <input type="text" id="webhookUrl" value="https://webhook.fbzia.com.br/webhook/entregaszap">

            <button onclick="testWebhookBasic()">üöÄ Testar Webhook B√°sico</button>
            <button onclick="clearLogs()" class="danger">üóëÔ∏è Limpar Logs</button>
        </div>

        <!-- Teste 2: Webhook Completo -->
        <div class="test-section">
            <h2>2. Teste Completo do Webhook</h2>
            <p>Envia um payload completo simulando uma entrega real.</p>

            <label>Nome do Morador:</label>
            <input type="text" id="moradorNome" value="Jo√£o da Silva">

            <label>Telefone (com DDI):</label>
            <input type="text" id="moradorTelefone" value="5511999999999">

            <label>C√≥digo de Retirada:</label>
            <input type="text" id="codigoRetirada" value="12345">

            <label>Observa√ß√£o (opcional):</label>
            <textarea id="observacao" rows="2" placeholder="Ex: Embalagem rasgada"></textarea>

            <button onclick="testWebhookComplete()">üì¶ Testar Webhook Completo</button>
        </div>

        <!-- Teste 3: Upload de Foto -->
        <div class="test-section">
            <h2>3. Teste de Upload de Foto (Supabase)</h2>
            <p>Testa o upload de uma foto para o Supabase Storage.</p>

            <label>Selecione uma Foto:</label>
            <input type="file" id="photoFile" accept="image/*">

            <button onclick="testPhotoUpload()">üì∏ Testar Upload de Foto</button>

            <div id="photoPreview" style="margin-top: 10px;"></div>
        </div>

        <!-- Teste 4: Fluxo Completo -->
        <div class="test-section">
            <h2>4. Teste Completo (Foto + Webhook)</h2>
            <p>Testa todo o fluxo: upload da foto + envio do webhook com a URL da foto.</p>

            <button onclick="testCompleteFlow()">üéØ Testar Fluxo Completo</button>
        </div>

        <!-- Logs -->
        <div class="test-section">
            <h2>üìã Logs de Teste</h2>
            <div id="logs" class="log">
                <div class="log-entry info">Aguardando testes...</div>
            </div>
        </div>
    </div>

    <script>
        const logsDiv = document.getElementById('logs');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLogs() {
            logsDiv.innerHTML = '<div class="log-entry info">Logs limpos.</div>';
        }

        // Teste 1: Webhook B√°sico
        async function testWebhookBasic() {
            const webhookUrl = document.getElementById('webhookUrl').value;

            log('üöÄ Iniciando teste b√°sico do webhook...', 'info');
            log(`URL: ${webhookUrl}`, 'info');

            const payload = {
                condominio: "Teste Condom√≠nio",
                morador: "Teste Morador",
                mensagem: "Teste de webhook b√°sico",
                telefone: "5511999999999"
            };

            log(`üì§ Payload: ${JSON.stringify(payload, null, 2)}`, 'info');

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                log(`‚úÖ Resposta recebida - Status: ${response.status} ${response.statusText}`, 'success');

                const responseText = await response.text();
                log(`üì• Resposta do servidor: ${responseText}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    log('üéâ WEBHOOK FUNCIONANDO!', 'success');
                } else {
                    log(`‚ùå Webhook retornou erro: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro ao chamar webhook: ${error.message}`, 'error');
                log(`üí° Verifique: 1) URL correta, 2) CORS configurado, 3) Webhook online`, 'warning');
            }
        }

        // Teste 2: Webhook Completo
        async function testWebhookComplete() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            const morador = document.getElementById('moradorNome').value;
            const telefone = document.getElementById('moradorTelefone').value;
            const codigo = document.getElementById('codigoRetirada').value;
            const obs = document.getElementById('observacao').value;

            log('üì¶ Iniciando teste completo do webhook...', 'info');

            const payload = {
                condominio: "Edif√≠cio Solar",
                morador: morador,
                mensagem: `Ol√° ${morador}, voc√™ tem uma nova encomenda!\n\nC√≥digo: ${codigo}`,
                telefone: telefone,
                codigo_retirada: codigo
            };

            if (obs && obs.trim()) {
                payload.observacao = obs.trim();
                log(`üìù Observa√ß√£o inclu√≠da: ${obs}`, 'info');
            }

            log(`üì§ Payload completo: ${JSON.stringify(payload, null, 2)}`, 'info');

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                log(`‚úÖ Status: ${response.status}`, response.ok ? 'success' : 'error');

                const responseText = await response.text();
                log(`üì• Resposta: ${responseText}`, 'info');

                if (response.ok) {
                    log('üéâ WEBHOOK COMPLETO FUNCIONANDO!', 'success');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // Teste 3: Upload de Foto
        async function testPhotoUpload() {
            const fileInput = document.getElementById('photoFile');
            const file = fileInput.files[0];

            if (!file) {
                log('‚ö†Ô∏è Selecione uma foto primeiro!', 'warning');
                return;
            }

            log(`üì∏ Iniciando upload da foto: ${file.name}`, 'info');
            log(`üìä Tamanho: ${(file.size / 1024).toFixed(2)} KB`, 'info');
            log(`üé® Tipo: ${file.type}`, 'info');

            // Preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('photoPreview').innerHTML =
                    `<img src="${e.target.result}" style="max-width: 300px; border-radius: 5px;">`;
            };
            reader.readAsDataURL(file);

            // Simula√ß√£o (voc√™ precisaria importar o uploadPhoto real aqui)
            log('‚ö†Ô∏è Teste de upload requer c√≥digo do Supabase', 'warning');
            log('üí° Abra o Console (F12) da aplica√ß√£o principal e teste l√°', 'info');
        }

        // Teste 4: Fluxo Completo
        async function testCompleteFlow() {
            log('üéØ Teste de fluxo completo n√£o implementado nesta p√°gina', 'warning');
            log('üí° Use a aplica√ß√£o principal em http://localhost:3000', 'info');
        }

        log('‚úÖ P√°gina de testes carregada!', 'success');
        log('üí° Execute os testes acima para debugar o webhook', 'info');
    </script>
</body>
</html>
